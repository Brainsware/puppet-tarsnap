<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="puppet_class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="puppet_class_list.html"></iframe>

      <div id="content"><div id='filecontents'>
<h4 id="label-Table+of+Contents">Table of Contents</h4>
<ol><li>
<p><a href="#overview">Overview</a></p>
</li><li>
<p><a href="#module-description">Module Description - What the module does and
why it is useful</a></p>
</li><li>
<p><a href="#setup">Setup - The basics of getting started with tarsnap</a></p>
</li><li>
<p><a href="#usage">Usage - Configuration options and additional
functionality</a></p>
</li><li>
<p><a href="#reference">Reference - An under-the-hood peek at what the module
is doing and how</a></p>
</li><li>
<p><a href="#limitations">Limitations - OS compatibility, etc.</a></p>
</li><li>
<p><a href="#development">Development - Guide for contributing to the
module</a></p>
</li></ol>

<h2 id="label-Overview">Overview</h2>

<p>this module helps install and configure tarsnap.</p>

<p><strong>It does not, and cannot help you create keys for servers. You have
to do that manually</strong></p>

<h2 id="label-Setup">Setup</h2>

<p>The <code>tarsnap</code> module assumes that you have a package named
<code>tarsnap</code> in your package repositories. You can override this
expectation by either changing the <code>$package_name</code>, or by
setting it to <code>undef</code> if you have other means of installing it.</p>

<h3 id="label-PPA">PPA</h3>

<p>For Ubuntu, I have created a <a
href="https://launchpad.net/~tarsnap/+archive/ubuntu/lts">PPA</a> which
builds the latest version of tarsnap for all Ubuntu LTS. If you&#39;re
interested in helping with that, you can also join that team on launchpad.</p>

<h3 id="label-Keys">Keys</h3>

<p>In order for tarsnap to be fully functional, and thus for this module to
be, you must setup the key. Please follow the <a
href="https://www.tarsnap.com/gettingstarted.html">instructions of the
official documentation</a></p>

<p>As I&#39;d rather not be responsible for making your backups inaccessible
through a puppet hickup, keys are, as of yet, not created automatically
(and thus cannot be re-created automatically ;).</p>

<h2 id="label-Usage">Usage</h2>

<p>To install tarsnap from the package all that is needed is:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_include'>include</span> <span class='id identifier rubyid_tarsnap'>tarsnap</span>
</code></pre>

<p>We can change basic parameters such as the package name:</p>

<pre class="code ruby"><code class="ruby">class { &#39;tarsnap&#39;:
  package_name =&gt; &#39;acme-tarsnap&#39;,
}</code></pre>

<p>if the configuration file or the root key are not in the default locations,
we can change those as well:</p>

<pre class="code ruby"><code class="ruby">class { &#39;tarsnap&#39;:
  configfile =&gt; &#39;/usr/local/etc/tarsnap.conf&#39;,
  keyfile    =&gt; &#39;/secure/tarsnap.key&#39;,
}</code></pre>

<p>Many option that can be set in <code>tarsnap.conf</code> can be set through
the base class. The most important one is <code>$cachedir</code>. All
<code>boolean</code> options (those that can be prefaced with
<code>no-</code> in <code>tarsnap.conf</code>) can be set to
<code>true</code>/<code>false</code>.</p>

<pre class="code ruby"><code class="ruby">class { &#39;tarsnap&#39;:
  cachedir               =&gt; &#39;/var/backups/tarsnap&#39;,
  aggressive_networking  =&gt; false,
}</code></pre>

<p>n.b.: this module will guarantee that <code>$cachedir</code> exists as
directory and is <code>root</code>:<code>root</code> owned.</p>

<p>The easiest way to use tarsnap is from cron:</p>

<pre class="code ruby"><code class="ruby">cron { &#39;tarsnap-etc-daily&#39;:
  command =&gt; &quot;/usr/bin/tarsnap -c -f etc.`date +%Y%m%d` /etc /usr/local/etc /opt/etc&quot;,
  user    =&gt; &#39;root&#39;,
  hour    =&gt; 2,
  minute  =&gt; fqdn_rand(60),
}</code></pre>

<p>if we want to only keep the last 30 days, we can follow this up with:</p>

<pre class="code ruby"><code class="ruby">cron { &#39;dailiy-tarsnap-etc-trim-30&#39;:
  command =&gt; &quot;/usr/bin/tarsnap --list-archives | grep &#39;etc\.&#39; | sort -n | head -n +30 | xargs -n 1 /usr/bin/tarsnap -d -f&quot;
  user    =&gt; &#39;root&#39;,
  hour    =&gt; 3,
  minute  =&gt; fqdn_rand(60),
}</code></pre>

<p>We provide a convenience wrapper around those two expressions:</p>

<pre class="code ruby"><code class="ruby">tarsnap::periodic { &#39;etc&#39;:
  dirs =&gt; [ &#39;etc&#39;, &#39;/usr/local/etc&#39;, &#39;/opt/etc&#39; ],
  hour =&gt; 3,
}</code></pre>

<p>Often if we have a lot of periodic jobs, randomizing will still lead to
overlapping runs, which doesn&#39;t work with tarnsap. For this purpose we
provide a the class <code>tarsnap::batch</code>. It can also be directly
configured through <code>tarsnap</code>:</p>

<pre class="code ruby"><code class="ruby">class { &#39;tarsnap&#39;:
  batch_enable =&gt; false,
  locations    =&gt; {
    &#39;etc&#39;       =&gt; &#39;/etc&#39;,
    &#39;home&#39;      =&gt; [ &#39;/home/me/pix&#39;, &#39;/home/me/src&#39;, &#39;/home/me/txt&#39; ],
    &#39;.dotfiles&#39; =&gt; [ &#39;/home/me/.gnupg&#39;, &#39;/home/me/.config&#39;, &#39;/home/me/.ssh&#39; ],
    &#39;blog&#39;      =&gt; [ &#39;/home/me/blog/src&#39;, &#39;/home/me/blog/pix&#39; ],
  }
}</code></pre>

<h2 id="label-Reference">Reference</h2>

<h3 id="label-tarsnap">tarsnap</h3>
<ul><li>
<p><code>package_name</code>: Name of tarsnap package. If tarsnap is installed
by other means, set this to <code>undef</code> (Default:
<code>tarsnap</code>)</p>
</li><li>
<p><code>package_ensure</code>: Ensure tarsnap package is in this version,
<code>absent</code>, <code>present</code> or <code>latest</code>. (Default:
<code>present</code>)</p>
</li><li>
<p><code>configfile</code>: Path to tarsnap&#39;s configuration file.
(Default: <code>/etc/tarsnap.conf</code>)</p>
</li><li>
<p><code>path</code>: Path to tarsnap. (Default:
<code>/usr/bin/tarsnap</code>)</p>
</li><li>
<p><code>archive_path</code>: Path to tarsnap-archive script. (Default:
<code>/usr/local/bin/tarsnap-archive</code>)</p>
</li><li>
<p><code>rotate_path</code>: Path to tarsnap-rotate script. (Default:
<code>/usr/local/bin/tarsnap-rotate</code>)</p>
</li><li>
<p><code>batch_path</code>: Path to tarsnap-batch script. (Default:
<code>/usr/local/bin/tarsnap-batch</code>)</p>
</li><li>
<p><code>cachedir</code>: Path to tarsnap&#39;s cachedir. This directory will
be created by puppet. (Default: <code>/var/backups/tarsnap</code>)</p>
</li><li>
<p><code>keyfile</code>: Path to tarsnap&#39;s keyfile for this machine.
(Default: <code>/root/tarsnap.key</code>)</p>
</li><li>
<p><code>nodump</code>: Honor the <code>nodump</code> file flag. (Default:
<code>true</code>)</p>
</li><li>
<p><code>print_stats</code>: Print statistics when creating or deleting
archives. (Default: <code>true</code>)</p>
</li><li>
<p><code>checkpoint_bytes</code>: Create a checkpoint once per X of uploaded
data (Default: <code>1G</code>)</p>
</li><li>
<p><code>aggressive_networking</code>: Use multiple TCP connections when
writing archives. (Default: <code>undef</code>)</p>
</li><li>
<p><code>batch_enable</code>: Whether or not to include the batch-proccessing
class. (Default: <code>false</code>)</p>
</li><li>
<p><code>locations</code>: Hash of directory arrays to archive in a batch job.
(Default: <code>{}</code>)</p>
</li></ul>

<h3 id="label-tarsnap-3A-3Aperiodic">tarsnap::periodic</h3>
<ul><li>
<p><code>name</code>: base-name of this archive</p>
</li><li>
<p><code>ensure</code>: Ensure presence or absence of cron jobs. (Default:
<code>present</code>)</p>
</li><li>
<p><code>dirs</code>: Array of dirs to backup (Default: <code>[]</code>)</p>
</li><li>
<p><code>exclude</code>: Array of patterns to exclude from archives (Default:
<code>[]</code>)</p>
</li><li>
<p><code>keep</code>: How many archives to keep. If this is set to
<code>0</code> no archives will be deleted. (Default: <code>30</code>)</p>
</li><li>
<p><code>hour</code>: Hour when to run. (Default: <code>fqdn_rand(24,
$title)</code>, i.e.: between 00:xx and 23:xx)</p>
</li><li>
<p><code>minute</code>: Minute when to run. (Default: <code>fqdn_rand(60,
$title)</code>, i.e.: between xx:00 and xx:59)</p>
</li><li>
<p><code>month</code>: Month of year to run. (Default: <code>undef</code>)</p>
</li><li>
<p><code>monthday</code>: The day of the month on which to run. (Default:
<code>undef</code>)</p>
</li><li>
<p><code>offset</code>: Offset (in hours) when to run the cleanup job.
(Default: <code>1</code>)</p>
</li><li>
<p><code>weekday</code>: The weekday on which to run. (Default:
<code>undef</code>)</p>
</li></ul>

<h3 id="label-tarsnap-3A-3Abatch">tarsnap::batch</h3>
<ul><li>
<p><code>enable</code>: Ensure presence or absence of batch script and cron
job. (Default: <code>true</code>)</p>
</li><li>
<p><code>keep</code>: How many archives to keep. If this is set to
<code>0</code> no archives will be deleted. (Default: <code>30</code>)</p>
</li><li>
<p><code>hour</code>: Hour when to run. (Default: <code>fqdn_rand(6,
$title)</code>, i.e.: between 00:xx and 06:xx)</p>
</li><li>
<p><code>minute</code>: Minute when to run. (Default: <code>fqdn_rand(60,
$title)</code>, i.e.: between xx:00 and xx:59)</p>
</li><li>
<p><code>locations</code>: Hash of directory arrays. (Default:
<code>$::tarsnap::locations</code>)</p>
</li></ul>

<h2 id="label-Limitations">Limitations</h2>

<p>While it is possible to configure tarsnap on a per-user basis,
tarsnap::config currently is a class. If you think it&#39;s useful to
change that, please contribute!</p>

<h2 id="label-Development">Development</h2>

<p>Please use the github issues functionality to report any bugs or requests
for new features. Feel free to fork and submit pull requests for potential
contributions.</p>
</div></div>

      <div id="footer">
  Generated on Thu Dec  1 22:15:28 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.1).
</div>

    </div>
  </body>
</html>